import type { PipelineStage } from './pipelineStages';

export const ukPipelineStages: PipelineStage[] = [
  {
    id: 'frs',
    branch: 'shared',
    title: 'Family Resources Survey',
    subtitle: 'Base microdata',
    description: 'The Family Resources Survey (FRS) 2023-24 provides the baseline microdata, covering income, benefits, housing, and demographics for ~20,000 UK households. Variables are mapped to PolicyEngine\'s system, and benefit take-up rates are stochastically assigned.',
    icon: 'üìä',
    inputSize: '~20,000 households',
    outputSize: '~20,000 households',
    dataSources: ['DWP Family Resources Survey 2023-24'],
    details: [
      'Demographics: age, gender, marital status, employment status, education, region (12 UK regions)',
      '18+ reported benefit types: child benefit, universal credit, PIP, DLA, ESA, JSA, state pension, pension credit, housing benefit, carer\'s allowance, and more',
      'Income: employment, self-employment, private pension, savings interest, dividends, property, maintenance',
      'Housing: rent, council tax (with imputation for ~75% missing), mortgage interest/capital, tenure type, accommodation type',
      'Stochastic take-up: child benefit, UC, pension credit, marriage allowance, Scottish Child Payment',
      'Grossing weights from FRS GROSS4 field',
    ],
    imputations: [
      { name: 'Council tax (missing ~75%)', source: 'FRS 2023-24', method: 'Imputed from council tax band and regional rates' },
      { name: 'Benefit take-up (child benefit)', source: 'HMRC/DWP', method: 'Stochastic assignment at reported take-up rates' },
      { name: 'Benefit take-up (UC, pension credit)', source: 'DWP', method: 'Stochastic assignment at reported rates' },
      { name: 'Property purchase', source: 'HMRC transaction data', method: '3.85% stochastic assignment' },
      { name: 'Private school attendance', source: 'ISC Census 2024', method: 'Stochastic assignment by region' },
    ],
  },
  {
    id: 'wealth',
    branch: 'shared',
    title: 'Wealth imputation',
    subtitle: 'WAS ‚Üí FRS',
    description: 'Wealth variables are imputed from the Wealth and Assets Survey (WAS) Round 7 onto FRS households using quantile random forests. This adds property, financial, and pension wealth needed for capital tax calculations.',
    icon: 'üí∞',
    inputSize: '~20,000 households',
    outputSize: '~20,000 households',
    dataSources: ['Wealth and Assets Survey Round 7 (March 2022)'],
    details: [
      '11 predictors: household net income, adults, children, pension/employment/self-employment/capital income, bedrooms, council tax, renting, region',
      'Northern Ireland households mapped to Wales (WAS does not sample NI)',
      'Must run before consumption imputation (num_vehicles needed as predictor)',
    ],
    imputations: [
      { name: 'Owned land', source: 'WAS Round 7', method: 'Quantile random forest' },
      { name: 'Property wealth', source: 'WAS Round 7', method: 'Quantile random forest' },
      { name: 'Corporate wealth (pensions + shares + ISAs)', source: 'WAS Round 7', method: 'Quantile random forest' },
      { name: 'Gross/net financial wealth', source: 'WAS Round 7', method: 'Quantile random forest' },
      { name: 'Main residence value', source: 'WAS Round 7', method: 'Quantile random forest' },
      { name: 'Other residential property', source: 'WAS Round 7', method: 'Quantile random forest' },
      { name: 'Non-residential property', source: 'WAS Round 7', method: 'Quantile random forest' },
      { name: 'Savings', source: 'WAS Round 7', method: 'Quantile random forest' },
      { name: 'Number of vehicles', source: 'WAS Round 7', method: 'Quantile random forest' },
    ],
  },
  {
    id: 'consumption',
    branch: 'shared',
    title: 'Consumption imputation',
    subtitle: 'LCFS ‚Üí FRS',
    description: 'Spending patterns are imputed from the Living Costs and Food Survey (LCFS) onto FRS households, enabling VAT, fuel duty, and indirect tax modeling. A two-step bridge via WAS vehicle ownership corrects LCFS fuel underreporting.',
    icon: 'üõí',
    inputSize: '~20,000 households',
    outputSize: '~20,000 households',
    dataSources: ['Living Costs and Food Survey 2021-22', 'NTS 2024 (vehicle ownership)'],
    details: [
      '8 predictors: adult/child status, region, employment/self-employment/pension income, household net income, has_fuel_consumption',
      'Two-step fuel bridge: WAS vehicle ownership (78%) corrects LCFS diary undercount (58%)',
      'LCFS data uprated from 2021 to 2024 using CPI from OBR, with separate 1.3x fuel uprating',
    ],
    imputations: [
      { name: 'Food and non-alcoholic beverages', source: 'LCFS 2021-22', method: 'Quantile random forest' },
      { name: 'Alcohol and tobacco', source: 'LCFS 2021-22', method: 'Quantile random forest' },
      { name: 'Clothing and footwear', source: 'LCFS 2021-22', method: 'Quantile random forest' },
      { name: 'Housing, water, and electricity', source: 'LCFS 2021-22', method: 'Quantile random forest' },
      { name: 'Transport', source: 'LCFS 2021-22', method: 'Quantile random forest' },
      { name: 'Petrol and diesel spending', source: 'LCFS 2021-22', method: 'Quantile random forest (fuel-bridged)' },
      { name: 'Domestic energy consumption', source: 'LCFS 2021-22', method: 'Quantile random forest' },
      { name: 'Recreation, restaurants, education, health, etc.', source: 'LCFS 2021-22', method: 'Quantile random forest (7 additional COICOP categories)' },
    ],
  },
  {
    id: 'vat-services',
    branch: 'shared',
    title: 'VAT and public services',
    subtitle: 'ETB + NHS data',
    description: 'VAT expenditure rates and public service usage (NHS, education, transport subsidies) are imputed from the Effects of Taxes and Benefits survey and NHS administrative data.',
    icon: 'üè•',
    inputSize: '~20,000 households',
    outputSize: '~20,000 households',
    dataSources: ['Effects of Taxes and Benefits survey (2020)', 'NHS consumption by age/gender', 'NTS 2024'],
    details: [
      'VAT: full-rate expenditure share imputed via QRF (assumes 3% at reduced rate per OBR)',
      'NHS: deterministic assignment of per-person spending by age-gender cell, scaled to ¬£202bn 2025/26 budget',
      'NHS visit types: A&E, admitted patient, outpatient (6 variables)',
      'Education: DfE spending by primary/secondary/further education',
      'Transport: rail and bus subsidy spending from ETB',
    ],
    imputations: [
      { name: 'Full-rate VAT expenditure rate', source: 'ETB 2020', method: 'Quantile random forest' },
      { name: 'NHS A&E/admitted/outpatient visits and spending', source: 'NHS data', method: 'Deterministic by age-gender cell' },
      { name: 'Education spending (DfE)', source: 'ETB 2020', method: 'Quantile random forest' },
      { name: 'Rail and bus subsidy', source: 'ETB 2020', method: 'Quantile random forest' },
    ],
  },
  {
    id: 'spi-income',
    branch: 'shared',
    title: 'SPI income imputation',
    subtitle: 'HMRC ‚Üí FRS (stacked)',
    description: 'Income variables are imputed from the HMRC Survey of Personal Incomes (SPI) to enrich the high-income tail. The FRS is stacked: original records keep their income, and a zero-weight copy receives SPI-imputed incomes. Calibration later activates the most informative records.',
    icon: 'üèõÔ∏è',
    inputSize: '~20,000 households + 100,000 SPI records',
    outputSize: '~30,000 households (stacked)',
    dataSources: ['HMRC Survey of Personal Incomes 2020-21'],
    details: [
      'Original FRS: only dividend_income imputed from SPI',
      'Zero-weight copy (10,000 households): all 6 income variables imputed',
      'Stacked: original + zero-weight records (calibration decides which to activate)',
      '3 predictors: age, gender, region',
      'Rent and mortgage adjusted proportionally to income changes',
    ],
    imputations: [
      { name: 'Employment income', source: 'SPI 2020-21', method: 'Quantile random forest (zero-weight copy)' },
      { name: 'Self-employment income', source: 'SPI 2020-21', method: 'Quantile random forest (zero-weight copy)' },
      { name: 'Savings interest income', source: 'SPI 2020-21', method: 'Quantile random forest (zero-weight copy)' },
      { name: 'Dividend income', source: 'SPI 2020-21', method: 'Quantile random forest (both copies)' },
      { name: 'Private pension income', source: 'SPI 2020-21', method: 'Quantile random forest (zero-weight copy)' },
      { name: 'Property income', source: 'SPI 2020-21', method: 'Quantile random forest (zero-weight copy)' },
    ],
  },
  {
    id: 'capital-gains',
    branch: 'shared',
    title: 'Capital gains',
    subtitle: 'Advani-Summers distribution',
    description: 'Capital gains are imputed using percentile distributions from Advani & Summers research, split by income band. The dataset is doubled: each household appears as a "has gains" and "no gains" copy, with PyTorch-optimised weight splitting matching the income-band-specific percentage with gains.',
    icon: 'üìà',
    inputSize: '~30,000 households',
    outputSize: '~60,000 households (doubled)',
    dataSources: ['Advani & Summers capital gains percentile distributions'],
    details: [
      'Dataset duplicated: each household gets "has CG" and "no CG" versions',
      'PyTorch Adam optimiser with sigmoid blend factors splits each household\'s weight',
      '100 optimisation epochs matching income-band-specific gain percentages',
      'CG amounts assigned via univariate splines fit to percentile distributions (p05-p95)',
    ],
  },
  {
    id: 'misc-imputations',
    branch: 'shared',
    title: 'Other imputations',
    subtitle: 'Salary sacrifice, student loans',
    description: 'Remaining imputations cover salary sacrifice pension contributions (from FRS respondents asked about SALSAC) and student loan plan assignment based on age and reported repayments.',
    icon: 'üéì',
    inputSize: '~60,000 households',
    outputSize: '~60,000 households',
    dataSources: ['FRS 2023-24 (SALSAC field)', 'Student loan plan rules'],
    details: [
      'Salary sacrifice: QRF trained on ~4,000 FRS jobs with SALSAC response, imputed to ~13,000 not asked',
      'Student loan plan: rule-based from age and repayments (Plan 1 before 2012, Plan 2 2012-2023, Plan 5 2023+)',
      'Uprating from 2023 to 2025 using OBR economic assumptions for all variables',
    ],
    imputations: [
      { name: 'Pension contributions via salary sacrifice', source: 'FRS 2023-24', method: 'Quantile random forest from age, employment income' },
      { name: 'Student loan plan type', source: 'Rules', method: 'Deterministic from age and repayment status' },
    ],
  },
  {
    id: 'constituency-calibration',
    branch: 'national',
    isFinalDataset: true,
    title: 'Constituency calibration',
    subtitle: '650 √ó N weight matrix',
    description: 'Unlike the US L0 approach, the UK uses a weight matrix: a single 650 √ó N matrix where each constituency gets its own set of household weights, optimised jointly with national targets using gradient descent. Column sums give the national weights. This single dataset serves both national and constituency-level analysis.',
    icon: 'üó≥Ô∏è',
    inputSize: '~60,000 households (uprated)',
    outputSize: '650 √ó ~60,000 weight matrix',
    dataSources: ['ONS mid-year population estimates', 'HMRC SPI by constituency', 'DWP Stat-Xplore (UC)', 'OBR', 'HMRC', 'DWP', 'VOA'],
    details: [
      'PyTorch Adam optimiser (lr=0.1, 512 epochs), not L0 regularisation',
      'Country mask: households only get weight in constituencies of the same country (England/Wales/Scotland/NI)',
      'Country-aware initialisation: initial weight √∑ number of areas in household\'s country',
      '5% weight dropout for regularisation',
      'Symmetric relative loss: min(((1+x)/(1+y)-1)¬≤, ((1+y)/(1+x)-1)¬≤)',
      'Joint optimisation of constituency-level and national targets simultaneously',
      'Column sums = national weights (no separate national calibration needed)',
      'Boundary mapping: 2010-boundary constituency targets transformed to 2024 boundaries via population overlap matrix',
    ],
    calibrationTargets: [
      { variable: 'Income tax revenue', target: 'National total', source: 'OBR' },
      { variable: 'National Insurance (employee + employer)', target: 'National total', source: 'OBR' },
      { variable: 'Council tax (England/Scotland/Wales separately)', target: 'National + country', source: 'OBR' },
      { variable: 'VAT, fuel duties, CGT, SDLT, TV licence', target: 'National total', source: 'OBR' },
      { variable: 'Universal credit (total + jobseekers split)', target: 'National + per constituency', source: 'DWP Stat-Xplore' },
      { variable: 'State pension, pension credit, child benefit', target: 'National totals + caseloads', source: 'DWP/OBR' },
      { variable: 'PIP, DLA, ESA, JSA, housing benefit, carer\'s allowance', target: 'National totals + caseloads', source: 'DWP/OBR' },
      { variable: 'Population by region √ó age band', target: '12 regions √ó 9 bands', source: 'ONS mid-year estimates' },
      { variable: 'Income distribution by band', target: '6 income types √ó ~14 bands', source: 'HMRC income projection' },
      { variable: 'Employment/self-employment income by constituency', target: '650 constituencies', source: 'HMRC SPI' },
      { variable: 'Age demographics by constituency', target: '650 √ó 8 age bands', source: 'ONS' },
      { variable: 'Council tax bands by region', target: '11 regions √ó 8 bands', source: 'VOA/Scottish Govt' },
      { variable: 'Salary sacrifice', target: 'IT relief by band + total', source: 'HMRC' },
      { variable: 'Scottish Child Payment', target: '¬£471m total spend', source: 'Scottish Government' },
      { variable: 'Vehicle ownership', target: '0/1/2+ distribution', source: 'NTS 2024' },
      { variable: 'Mortgage payments, private rent', target: 'National totals', source: 'ONS' },
    ],
  },
  {
    id: 'la-calibration',
    branch: 'local',
    isFinalDataset: true,
    title: 'Local authority calibration',
    subtitle: '360 √ó N weight matrix',
    description: 'A second weight matrix covers 360 local authorities, using the same gradient descent approach but with additional LA-specific targets including ONS income estimates, tenure type, and private rents by area.',
    icon: 'üèòÔ∏è',
    inputSize: '~60,000 households (uprated)',
    outputSize: '360 √ó ~60,000 weight matrix',
    dataSources: ['ONS income estimates by MSOA', 'DWP Stat-Xplore (UC by LA)', 'ONS Census tenure data', 'VOA private rents'],
    details: [
      'Same PyTorch Adam optimiser and loss function as constituency calibration',
      'Same national targets plus LA-specific targets',
      'Additional targets not in constituency calibration: tenure type, private rents, ONS income estimates',
      'Output saved as separate local_authority_weights.h5',
    ],
    calibrationTargets: [
      { variable: 'Age demographics by LA', target: '360 √ó 8 age bands', source: 'ONS' },
      { variable: 'Employment/self-employment income by LA', target: '360 LAs', source: 'HMRC SPI' },
      { variable: 'UC households by LA', target: '360 LAs', source: 'DWP Stat-Xplore' },
      { variable: 'Equivalent net income (BHC/AHC)', target: 'Per LA', source: 'ONS MSOA income (uprated)' },
      { variable: 'Tenure type (owned/mortgage/private/social)', target: 'Per LA', source: 'ONS Census' },
      { variable: 'Private rent amounts', target: 'Per LA', source: 'VOA median rents' },
      { variable: '+ all national targets from constituency calibration', target: 'See above', source: 'OBR/HMRC/DWP/ONS' },
    ],
  },
];
